steps:
- task: NodeTool@0
  inputs:
    versionSpec: "12.13.0"
  displayName: 'use Node v12'
- script: |
    choco install jq
  displayName: 'install jq from choco'
- script: |
    choco install sed
  displayName: 'install sed from choco'
- task: YarnInstaller@3
  inputs:
    versionSpec: '1.x'
  displayName: 'install Yarn'
- task: UsePythonVersion@0
  inputs:
    versionSpec: 2.x
  displayName: 'use Python 2.x'
- task: ShellScript@2
  inputs:
    scriptPath: get_repo.sh
  displayName: 'get VSCode sources'
- task: ShellScript@2
  inputs:
    scriptPath: prepare.sh
  displayName: 'prepare sources'
- powershell: |
    $LATEST_MS_COMMIT="$(git -C vscodium\\vscode rev-list --tags --max-count=1)"
    $LATEST_MS_TAG="$(git -C vscodium\\vscode describe --tags)"
    Write-Host "##vso[task.setvariable variable=LATEST_MS_TAG]$LATEST_MS_TAG"
    Write-Host "##vso[task.setvariable variable=LATEST_MS_COMMIT]$LATEST_MS_COMMIT"
    Write-Host "##vso[task.setvariable variable=BUILD_SOURCEVERSION]$LATEST_MS_COMMIT"
  displayName: 'set env LATEST_MS_TAG, LATEST_MS_COMMIT'
- task: PowerShell@2
  inputs:
    filePath: '.\\check_tags.ps1'
  env:
    MAPPED_GITHUB_TOKEN: $(GITHUB_TOKEN)
  displayName: 'check tags'
- script: |
    git -C vscodium/vscode status
  displayName: 'vscode status'
- powershell: |
    Set-Location -ErrorAction Stop vscodium

    bash ./build.sh
  displayName: 'go build it!'
- bash: |
    mv vscodium\\vscode\\.build\\win32-$(BUILDARCH)\\system-setup\\VSCodeSetup.exe  MrCodeSetup-$(BUILDARCH)-${LATEST_MS_TAG}.exe
    mv vscodium\\vscode\\.build\\win32-$(BUILDARCH)\\user-setup\\VSCodeSetup.exe  MrCodeUserSetup-$(BUILDARCH)-${LATEST_MS_TAG}.exe
    mv vscodium\\vscode\\.build\\win32-$(BUILDARCH)\\archive\\VSCode-win32-$(BUILDARCH).zip  MrCode-win32-$(BUILDARCH)-${LATEST_MS_TAG}.zip
  condition: eq(variables['SHOULD_BUILD'], 'yes')
  displayName: 'move files'
- powershell: |
    bash ./vscodium/sum.sh
  condition: eq(variables['SHOULD_BUILD'], 'yes')
  displayName: 'compute sums'
- task: CopyFiles@2
  inputs:
    contents: |
      MrCode*.zip
      MrCodeUserSetup*.exe
      MrCodeSetup*.exe
      *.sha256
    targetFolder: $(Build.ArtifactStagingDirectory)
  condition: eq(variables['SHOULD_BUILD'], 'yes')
  displayName: 'copy artifacts to staging directory'
- task: GitHubRelease@1
  inputs:
    gitHubConnection: 'release'
    repositoryName: 'zokugun/MrCode'
    action: 'edit'
    tag: '$(LATEST_MS_TAG)'
    title: '$(LATEST_MS_TAG)'
    assetUploadMode: 'replace'
    addChangeLog: false
  condition: eq(variables['SHOULD_BUILD'], 'yes')
  displayName: 'release to GitHub'
- bash: ./vscodium/update_version.sh
  env:
    GITHUB_TOKEN: $(GITHUB_TOKEN)
    GITHUB_USERNAME: $(GITHUB_USERNAME)
  condition: eq(variables['SHOULD_BUILD'], 'yes')
  displayName: 'update versions'
